```js
// A代码
const arr1 = []

for(let i = 0; i < 10000000; i++) {
  arr1[i] = 1
}
```

```js
// A代码
const arr2 = []

arr2[1000000 - 1] = 1

for(let i = 0; i < 10000000; i++) {
  arr2[i] = 1
}
```

JS运行机制

浏览器 -> 内核 -> JS解析引擎



# V8引擎内部有多种方法存放JS数组类型



数组从 0 到 length - 1无空洞

会进入 **快速模式**, 存放定义为Array



数组中间有空洞

会进入 **字典模式** , 存放定义为 HashMap



这是V8的优化策略

保证使用最合适的数据结构来处理数据

如果遇到数据量过大或者松散结构, 就改变为HashMap数据结构

牺牲遍历性能, 换取访问性能



### 数组的存储方式

在 V8 中，JavaScript 数组的存储方式主要有两种：**快速模式（Fast Mode）** 和 **字典模式（Dictionary Mode）**。这两种模式对应不同的数组结构，V8 会根据数组的特性自动选择最合适的存储方式。

#### 1. 快速模式（Fast Mode）

当数组的索引从 `0` 到 `length - 1` 都连续且没有空洞时，V8 会选择将数组存储为 **紧凑数组**（也叫 Fast Elements）。这种模式下，数组被当作普通的连续内存块来处理，每个元素都可以通过索引直接访问。

- **优点**：存取速度非常快，适合大多数常见的数组操作。
- **场景**：数组元素紧密排列，无空洞，例如 `[1, 2, 3, 4]`。

#### 2. 字典模式（Dictionary Mode）

当数组中存在空洞（即某些索引位置上没有元素）时，V8 会将数组存储为 **稀疏数组**（Sparse Elements），实际上是使用了一种 **哈希表**（HashMap） 来存储。

- **优点**：对于稀疏数组，节省内存，因为不必为每个索引分配存储空间。
- **缺点**：由于使用哈希表，访问和遍历性能较低。
- **场景**：数组中包含空洞，例如 `[1, , 3, , 5]`。

### 优化策略

V8 的优化策略是根据数组的实际使用情况，自动在这两种模式之间切换，以确保使用最合适的数据结构处理数据：

- **小而紧密的数组** 通常会被存储在快速模式下，以保证遍历和访问速度。
- **大而稀疏的数组** 会被切换到字典模式，以节省内存，但牺牲了遍历性能。

这种策略的核心在于**权衡性能和内存使用**。快速模式下的数组遍历和访问性能更好，而字典模式则在面对稀疏或大规模数组时更节省内存，但访问速度较慢。
